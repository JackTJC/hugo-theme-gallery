{{ define "main" }}
<div id="map" style="height: 80vh;"></div>

<!-- 引入 Leaflet.js 库 -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<!-- PhotoSwipe (v5) -->
<link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css">
<script type="module">
  // PhotoSwipe v5 使用 ES Module，所以我们在这里导入它
  // 我们将把它附加到 window 对象，以便在下面的常规脚本中使用
  import PhotoSwipe from 'https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js';
  window.PhotoSwipe = PhotoSwipe;
</script>

<style>
  /* 自定义照片标记样式 */
  .leaflet-photo-icon {
    background: transparent;
    border: none;
  }
  .leaflet-photo-icon img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.5);
    object-fit: cover;
    transition: transform 0.2s ease-in-out;
  }
  .leaflet-photo-icon img:hover {
    transform: scale(1.1);
  }
  .leaflet-popup-content-wrapper {
    border-radius: 8px;
    background-color: #fff; /* 确保背景不透明 */
  }
 .leaflet-popup-content {
    margin: 13px 19px;
    text-align: center;
  }
  /* .popup-thumbnail {
    width: 150px; /* 稍微放大弹窗中的图片，更易于点击 */
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
  } */
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var map = L.map('map').setView([35, 105], 4); // 默认中心点设为中国

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var photos = [
      {{ range .Site.Pages }}
        {{ range .Resources.ByType "image" }}
            {{ if and .Exif .Exif.Lat .Exif.Long }}
              {
                "lat": {{ .Exif.Lat }},
                "lon": {{ .Exif.Long }},
                "src": "{{ printf "%s%s%s" site.Params.cos_base_url .RelPermalink "?imageMogr2/thumbnail/1600x1600"}}",
                "downloadSrc": "{{ printf "%s%s" site.Params.cos_base_url .RelPermalink}}",
                "thumbnail": "{{ printf "%s%s%s" site.Params.cos_base_url .RelPermalink "?imageMogr2/thumbnail/300x300"}}",
                "pop_thumbnail": "{{ printf "%s%s%s" site.Params.cos_base_url .RelPermalink "?imageMogr2/thumbnail/80x80"}}",
                "caption": "{{ with $.Title }}{{ . }}{{ else }}{{ $.Name }}{{ end }}",
                "w": {{ .Width }},  // 添加原始宽度
                "h": {{ .Height }} // 添加原始高度
              },
            {{ end }}
        {{ end }}
      {{ end }}
    ];

    photos.forEach(function(photo,index) {
              // 使用 L.divIcon 创建基于 HTML 的自定义图标
      var photoIcon = L.divIcon({
        html: '<img src="' + photo.thumbnail + '" alt="' + photo.caption + '">',
        className: 'leaflet-photo-icon', // 应用自定义 CSS
        iconSize: [50, 50],       // 图标尺寸
        iconAnchor: [25, 50]      // 图标锚点（底部中心）
      });
      var marker = L.marker([photo.lat, photo.lon],{icon:photoIcon}).addTo(map);
      // 移除 bindPopup，直接监听 marker 的 'click' 事件
      marker.on('click', function() {
        // 检查 PhotoSwipe 库是否已加载
        if (window.PhotoSwipe) {
          const options = {
            dataSource: photos, // 数据源是所有照片的数组
            index: index,       // 从当前点击的这张照片开始预览 (利用闭包特性)
            pswpModule: window.PhotoSwipe
          };
          const lightbox = new window.PhotoSwipe(options);
           // --- 步骤 3: 自定义 UI，添加下载按钮 ---
          // 在 PhotoSwipe 初始化之前，注册一个新的 UI 元素
          lightbox.on('uiRegister', function() {
            lightbox.ui.registerElement({
              name: 'download-button',
              order: 8,
              isButton: true,
              tagName: 'a',

              // SVG for the download icon
              html: {
          isCustomSVG: true,
          inner: '<path d="M20.5 14.3 17.1 18V10h-2.2v7.9l-3.4-3.6L10 16l6 6.1 6-6.1ZM23 23H9v2h14Z" id="pswp__icn-download"/>',
          outlineID: "pswp__icn-download",
              },
              
              onInit: (el, pswp) => {
                // 设置 `<a>` 标签的属性
                el.setAttribute('title', 'Download high-resolution image');
                el.setAttribute('target', '_blank');
                el.setAttribute('rel', 'noopener'); // 安全性考虑
                
                // 监听 PhotoSwipe 的 'change' 事件，每次切换图片时更新下载链接
                pswp.on('change', () => {
                  const currSlide = pswp.currSlide;
                  if (currSlide && currSlide.data.downloadSrc) {
                    el.href = currSlide.data.downloadSrc;
                  }
                });
              }
            });
          });

          lightbox.init(); // 初始化并打开预览
        } else {
            console.error("PhotoSwipe library is not loaded.");
        }
      });
    });
  });
</script>
{{ end }}